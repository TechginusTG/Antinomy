<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>설문조사</title>
  <link rel="stylesheet" href="/css/test.css"/>
</head>
<body>                                          
  <div class="container">
    <h1>설문조사</h1>
    <form id="surveyForm" class="space-y-6"></form>
    <div class="buttons">
      <button type="button" id="prevBtn" disabled>이전</button>
      <button type="button" id="nextBtn">다음</button>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const form = document.getElementById("surveyForm");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const socket = io();

    let currentStep = 1; // 1: 문항, 2: 제출

    function renderCustomPage() {
      form.innerHTML = '';
      const questions = [
        {
        label: "관절 또는 신체 기능 문제로 인해 병원 진료를 받은 적이 있습니까?",
        inputs: `
        <label><input type="radio" name="injured" value="네"> 네</label>
        <input type="text" name="InjuredDetail" placeholder="어떤 진단을 받으셨는지 명시">
        <label><input type="radio" name="injured" value="아니오"> 아니오</label>
          `
        },
        {
          label: "현재 복용 중인 관절 또는 근육 관련 약물이 있습니까?",
          inputs: `
            <label><input type="radio" name="muscle" value="네"> 네</label>
            <input type="text" name="DrugAbuse" placeholder="약물명">
            <label><input type="radio" name="muscle" value="아니오"> 아니오</label>
          `
        },
        {
          label: "현재 겪고 있는 관절 문제가 일상생활에 미치는 영향",
          inputs: `
            <div class="options">
              <label><input type="radio" name="JointProblem" value="전혀 없음"> 전혀 없음</label>
              <label><input type="radio" name="JointProblem" value="약간 있음"> 약간 있음</label>
              <label><input type="radio" name="JointProblem" value="중간"> 중간</label>
              <label><input type="radio" name="JointProblem" value="상당히 있음"> 상당히 있음</label>
              <label><input type="radio" name="JointProblem" value="매우 심함"> 매우 심함</label>
            </div>
          `
        },
        {
          label: "기타 건강상 특이사항",
          inputs: `<textarea name="etc" placeholder="자유롭게 기재해주세요"></textarea>`
        }
      
      ];
    
       questions.forEach((q, index) => {
       const questionDiv = document.createElement('div');
       questionDiv.className = 'question';
       questionDiv.innerHTML = `
       <label>${index + 1}. ${q.label}</label>
       <div class="inputs">${q.inputs}</div>
    `;
      form.appendChild(questionDiv);
  });
  

    prevBtn.disabled = false;
    nextBtn.textContent = '제출';
   }
   function saveSurveyToCookies() {
    const customMap = [
      {name: 'injured', type: 'radio'},
      {name: 'InjuredDetail', type: 'text'},
      {name: 'muscle', type: 'radio'},
      {name: 'DrugAbuse', type: 'text'},
      {name: 'JointProblem', type: 'radio'},
      {name: 'etc', type: 'textarea'}
    ];

    customMap.forEach(({name, type}) => {
      let value = '';
      if (type === 'radio') {
        const checked = form.querySelector(`input[name="${name}"]:checked`);
        value = checked ? checked.value : '';
      } else if (type === 'text' || type === 'textarea') {
        const input = form.querySelector(`[name="${name}"]`);
        value = input ? input.value : '';
      } else if (type === 'checkbox') {
        const checked = Array.from(form.querySelectorAll(`input[name="${name}"]:checked`));
        value = checked.map(c => c.value).join(',');
      }
      setCookie(name + 'Score', value, 7);
    });
  }

  function setCookie(name, value, days) {
    let expires = '';
    if (days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = '; expires=' + date.toUTCString();
    }
    document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
  }

    nextBtn.addEventListener('click', () => {
      // 설문 결과 수집
      const customMap = [
        {name: 'injured', type: 'radio'},
      {name: 'InjuredDetail', type: 'text'},
      {name: 'muscle', type: 'radio'},
      {name: 'DrugAbuse', type: 'text'},
      {name: 'JointProblem', type: 'radio'},
      {name: 'etc', type: 'textarea'}
      ];
      const surveyResult = {};
      customMap.forEach(({name, type}) => {
        let value = '';
        if (type === 'radio') {
          const checked = form.querySelector(`input[name="${name}"]:checked`);
          value = checked ? checked.value : '';
        } else if (type === 'text' || type === 'textarea') {
          const input = form.querySelector(`[name="${name}"]`);
          value = input ? input.value : '';
        } else if (type === 'checkbox') {
          const checked = Array.from(form.querySelectorAll(`input[name="${name}"]:checked`));
          value = checked.map(c => c.value);
        }
        surveyResult[name] = value;
      });
      // 서버로 socketId와 traits 전송
      fetch("/api/survey", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ socketId: socket.id, traits: surveyResult })
      })
      .then(res => res.json())
      .then(data => {
        alert("사용자 특성이 저장되었습니다. 감사합니다!");
        window.close();
      })
      .catch(() => {
        alert("서버 전송 실패");
      });
      currentStep = 2;
    });
 
    // 초기 로딩
    renderCustomPage();
  
  </script>
</body>
</html>